@model BTickets.ViewModel.ShoppingCartVM

@{
	ViewData["Title"] = "Shopping Cart";
}

<div class="container mt-4">
	<div class="row justify-content-center">
		<div class="col-md-10">
			<div class="text-center mb-4">
				<h2 class="display-4 mb-3">
					<i class="bi bi-cart3 text-primary"></i>
					Shopping Cart
				</h2>
				<p class="lead text-muted">Review your movie selections</p>
			</div>

			@if (Model.ShoppingCart.ShoppingCartItems != null && Model.ShoppingCart.ShoppingCartItems.Any())
			{
				<div class="card shadow-sm mb-4">
					<div class="card-body">
						<div class="table-responsive">
							<table class="table table-hover align-middle">
								<thead class="table-dark">
									<tr class="text-center">
										<th scope="col">Movie</th>
										<th scope="col">Price</th>
										<th scope="col">Quantity</th>
										<th scope="col">Total</th>
										<th scope="col">Actions</th>
									</tr>
								</thead>
								<tbody>
									@foreach (var item in Model.ShoppingCart.ShoppingCartItems)
									{
										<tr class="text-center">
											<td>
												<div class="d-flex align-items-center">
													@if (!string.IsNullOrEmpty(item.Movie.ImageURL))
													{
														<img src="@item.Movie.ImageURL"
															 alt="@item.Movie.Name"
															 class="me-3 rounded"
															 style="width: 60px; height: 80px; object-fit: cover;">
													}
													<div class="text-start">
														<h6 class="mb-1">@item.Movie.Name</h6>
														<small class="text-muted">@item.Movie.Cinema?.Name</small>
													</div>
												</div>
											</td>
											<td>
												<strong class="text-success">$@item.Movie.Price.ToString("F2")</strong>
											</td>
											<td>
												<span class="badge bg-primary rounded-pill fs-6">@item.Amount</span>
											</td>
											<td>
												<strong class="text-primary">$@((item.Movie.Price * item.Amount).ToString("F2"))</strong>
											</td>
											<td>
												<div class="btn-group btn-group-sm">
													<a asp-action="AddToShoppingCart"
													   asp-route-id="@item.Movie.Id"
													   class="btn btn-outline-success"
													   title="Add One More">
														<i class="bi bi-plus"></i>
													</a>
													<a asp-action="RemoveFromShoppingCart"
													   asp-route-id="@item.Movie.Id"
													   class="btn btn-outline-danger"
													   title="Remove One">
														<i class="bi bi-dash"></i>
													</a>
												</div>
											</td>
										</tr>
									}
								</tbody>
							</table>
						</div>
					</div>
				</div>

				<div class="row">
					<div class="col-md-6 offset-md-6">
						<div class="card bg-light">
							<div class="card-body">
								<h5 class="card-title text-center">
									<i class="bi bi-receipt"></i> Order Summary
								</h5>
								<hr>
								<div class="d-flex justify-content-between mb-2">
									<span>Items:</span>
									<span>@Model.ShoppingCart.ShoppingCartItems.Sum(x => x.Amount)</span>
								</div>
								<div class="d-flex justify-content-between mb-3">
									<strong>Total:</strong>
									<strong class="text-success fs-4">$@Model.ShoppingCartTotal.ToString("F2")</strong>
								</div>

								<div class="d-grid gap-2">
									<a asp-action="CompleteOrder" class="btn btn-success btn-lg">
										<i class="bi bi-credit-card"></i> Complete Order (Traditional)
									</a>

									<div class="mt-3">
										<p class="text-center text-muted mb-2">Or pay with:</p>
										<div class="d-grid gap-2 mt-2">
											<div id="paypal-button-container"></div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			}
			else
			{
				<div class="text-center py-5">
					<div class="mb-4">
						<i class="bi bi-cart-x display-1 text-muted"></i>
					</div>
					<h3 class="text-muted mb-3">Your Cart is Empty</h3>
					<p class="lead text-muted mb-4">
						Looks like you haven't added any movies to your cart yet.
					</p>
					<a asp-controller="Movies" asp-action="Index" class="btn btn-primary btn-lg">
						<i class="bi bi-film"></i> Browse Movies
					</a>
				</div>
			}

			<div class="text-center mt-4">
				<a asp-controller="Movies" asp-action="Index" class="btn btn-outline-primary me-2">
					<i class="bi bi-arrow-left"></i> Continue Shopping
				</a>
				<a asp-action="Index" class="btn btn-outline-secondary">
					<i class="bi bi-list-check"></i> View Orders
				</a>
			</div>
		</div>
	</div>
</div>

@if (TempData["SuccessMessage"] != null)
{
	<div class="position-fixed top-0 end-0 p-3" style="z-index: 11">
		<div class="alert alert-success alert-dismissible fade show" role="alert">
			<i class="bi bi-check-circle"></i> @TempData["SuccessMessage"]
			<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
		</div>
	</div>
}

@if (TempData["ErrorMessage"] != null)
{
	<div class="position-fixed top-0 end-0 p-3" style="z-index: 11">
		<div class="alert alert-danger alert-dismissible fade show" role="alert">
			<i class="bi bi-exclamation-circle"></i> @TempData["ErrorMessage"]
			<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
		</div>
	</div>
}

@section Scripts {
	<script src="https://www.paypal.com/sdk/js?client-id=AcKRtgL4i68EZ2ZYuYUx3ilihAg2YhL5dtF_m19A8MjBWVOn6ewNS4M_uV8gA3xi98zTcUq38gUHbVFx&currency=USD&intent=capture"></script>
	<script>
		const total = '@Model.ShoppingCartTotal.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)';

		paypal.Buttons({
			style: { shape: 'pill', color: 'gold', layout: 'vertical' },
			createOrder: function (data, actions) {
				return actions.order.create({
					purchase_units: [{
						amount: { value: total, currency_code: 'USD' }
					}]
				});
			},
			onApprove: function (data, actions) {
				return actions.order.capture().then(function () {
					window.location.href = '@Url.Action("CompleteOrder", "Orders")';
				});
			}
		}).render('#paypal-button-container');
	</script>
}